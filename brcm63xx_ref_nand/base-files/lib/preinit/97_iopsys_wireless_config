#!/bin/sh

iopsys_generate_wireless_config() {
	local wls="wl0 wl1 wl2 wl3"
	local bands band freq

	for wl in $wls; do
		if wlctl -i $wl ap >/dev/null 2>&1; then
			if ! uci get wireless.$wl >/dev/null 2>&1; then
				bands=$(wlctl -i $wl bands)
				case "$bands" in
					*b*) band="b"; freq="" ;;
					*a*) band="a"; freq="-5G" ;;
					*) band="auto"; freq="" ;;
				esac
				cat >> /etc/config/wireless <<EOF
config 'wifi-device' '$wl'
        option 'type' 'broadcom'
        option 'channel' 'auto'
        option 'scantimer' '10'
        option 'hwmode' 'auto'
        option 'country' 'SE'
        option 'wmm' '1'
        option 'wmm_noack' '0'
        option 'wmm_apsd' '1'
        option 'txpower' '100'
        option 'rateset' 'default'
        option 'frag' '2346'
        option 'rts' '2347'
        option 'dtim_period' '1'
        option 'beacon_int' '100'
        option 'rxchainps' '0'
        option 'rxchainps_qt' '10'
        option 'rxchainps_pps' '10'
        option 'band' '$band'
        option 'rifs' '0'
        option 'rifs_advert' '0'
        option 'doth' '0'

config 'wifi-iface'
        option 'device' '$wl'
        option 'network' 'lan'
        option 'mode' 'ap'
        option 'ssid' 'Inteno-\$BSSID4$freq'
        option 'encryption' 'psk2'
        option 'key' '\$WPAKEY'
        option 'gtk_rekey' '3600'
        option 'macfilter' '0'
        option 'wps_pbc' '1'
        option 'wmf_bss_enable' '1'

EOF
			fi
		fi
	done

}

boot_hook_add preinit_main iopsys_generate_wireless_config

